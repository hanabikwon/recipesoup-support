# 토끼굴 마일스톤 시스템 - 언락 조건 완전 가이드

> **⚠️ 중요**: 이 문서는 실제 구현 코드(`burrow_unlock_service.dart`)를 ultra think 방식으로 분석하여 작성된 정확한 언락 조건입니다.

## 개요

토끼굴 마일스톤 시스템은 **32개 성장 마일스톤**과 **16개 특별공간**으로 구성됩니다.

### 성장 마일스톤 (32단계)
- **목표**: 70개 레시피 달성
- **진행**: 1→2→3→4→5→7→9→11→...→70개 레시피 (점진적 증가)
- **조건**: 레시피 개수만 충족하면 자동 언락

### 특별공간 (16개)
- **복잡한 조건**: 각 특별공간마다 고유한 언락 조건
- **추적 시스템**: `UnlockProgress` 객체로 진행도 관리
- **키워드 매칭**: 감정 스토리에서 특정 키워드 추출 및 매칭

---

## 🎭 특별공간 언락 조건 (실제 구현 기준)

### 1. 🏰 Ballroom (무도회장) - 사교적 요리사
**조건**: 3개 레시피에서 **3명 이상**의 사람 언급
**구현**: `_checkBallroomCondition()`, `_extractMentionedPeople()`

**키워드 시스템**:
```dart
// 27개 관계 키워드 (감정 스토리에서 추출)
const relationKeywords = [
  '엄마', '아빠', '부모님', '어머니', '아버지',
  '가족', '형', '누나', '언니', '동생', '오빠',
  '친구', '동료', '선배', '후배', '동기',
  '남자친구', '여자친구', '연인', '애인', '남편', '아내',
  '할머니', '할아버지', '이모', '삼촌', '고모', '외삼촌',
  '아이', '딸', '아들', '손자', '손녀',
  '선생님', '교수님', '사장님', '팀장님',
  '이웃', '룸메이트', '반려동물'
];
```

**진행 방식**:
1. 레시피의 감정 스토리에서 관계 키워드 추출
2. 3개 레시피 달성 + 언급된 사람 3명 이상 = 언락
3. 메타데이터로 `mentionedPeople` 리스트 관리

---

### 2. ♨️ Hot Spring (온천탕) - 힐링 요리사
**조건**: `sad`, `tired`, `nostalgic` 감정을 **각각 1개씩** 총 3개
**구현**: `_checkHotSpringCondition()`

**진행 방식**:
1. 레시피의 `mood`가 3가지 힐링 감정 중 하나여야 함
2. 감정별 카운트를 메타데이터 `moodCounts`로 추적
3. 각 감정마다 최소 1개씩 = 언락

**예시**:
```json
{
  "sad": 1,      // 슬픈 감정 레시피 1개
  "tired": 1,    // 피로한 감정 레시피 1개
  "nostalgic": 1 // 그리운 감정 레시피 1개
}
```

---

### 3. 🎼 Orchestra (오케스트라) - 감정 마에스트로
**조건**: **8가지 모든 감정** 상태 달성
**구현**: `_checkOrchestraCondition()`

**8가지 감정**:
- `happy` (기쁨)
- `peaceful` (평온)
- `sad` (슬픔)
- `tired` (피로)
- `excited` (설렘)
- `nostalgic` (그리움)
- `comfortable` (편안함)
- `grateful` (감사)

**진행 방식**:
1. 메타데이터 `achievedMoods`로 달성한 감정 추적
2. 모든 감정 8개 달성 = 언락

---

### 4. 🧪 Alchemy Lab (연금술실) - 도전적 요리사
**조건**: **실패(2점 이하) → 성공(4점 이상)** 패턴 **3회**
**구현**: `_checkAlchemyLabCondition()`

**진행 방식**:
1. 동일한 제목의 이전 레시피들을 검색
2. 제목 정규화: 특수문자 제거 후 매칭
3. 이전 평점 ≤ 2점, 현재 평점 ≥ 4점인 패턴 찾기
4. 3회 달성 = 언락

**Fallback 시스템**: HiveService 에러 시 현재 레시피 평점 4+ 로만 판단

---

### 5. 🍽️ Fine Dining (파인다이닝) - 완벽주의자
**조건**: **평점 5점** 레시피 **5개**
**구현**: `_checkFineDiningCondition()`

**진행 방식**:
1. 레시피 평점이 정확히 5점이어야 함
2. 5개 달성 = 언락

---

### 6. 🏔️ Alps (알프스) - 극한 도전자
**조건**: **재료 5개 이상** + **평점 4점 이상** 레시피 **3개**
**구현**: `_checkAlpsCondition()`

**진행 방식**:
1. `ingredients.length >= 5`
2. `rating >= 4`
3. 두 조건을 모두 만족하는 레시피 3개 = 언락

---

### 7. 🏕️ Camping (캠핑장) - 자연 애호가
**조건**: **자연 키워드** 포함 레시피 **4개**
**구현**: `_checkCampingCondition()`

**자연 키워드 (16개)**:
```dart
const natureKeywords = [
  '자연', '야외', '캠핑', '숲', '산', '강', '바다', '하늘',
  '바람', '공기', '햇살', '나무', '풀', '꽃', '새', '별'
];
```

**진행 방식**:
1. 감정 스토리에서 자연 키워드 매칭
2. 키워드 포함 레시피 4개 = 언락

---

### 8. 🍂 Autumn (가을 정원) - 가을 감성가
**조건**: **가을 키워드** 포함 레시피 **4개**
**구현**: `_checkAutumnCondition()`

**가을 키워드 (15개)**:
```dart
const autumnKeywords = [
  '가을', '단풍', '추위', '쌀쌀', '고구마', '밤', '감', '코스모스',
  '낙엽', '억새', '국화', '단감', '배', '도토리', '은행'
];
```

---

### 9. 🌸 Spring Picnic (봄날의 피크닉) - 외출 요리사
**조건**: **외출 키워드** 포함 레시피 **4개**
**구현**: `_checkSpringPicnicCondition()`

**외출 키워드 (12개)**:
```dart
const outdoorKeywords = [
  '나들이', '외출', '여행', '산책', '공원', '피크닉', '소풍',
  '드라이브', '나가서', '밖에서', '야외에서', '외식'
];
```

---

### 10. 🏄 Surfing (서핑 비치) - 해변 요리사
**조건**: **해변 키워드** 포함 레시피 **4개**
**구현**: `_checkSurfingCondition()`

**해변 키워드 (6개)**:
```dart
const beachKeywords = [
  '바다', '해변', '파도', '서핑', '바닷바람', '해수욕'
];
```

---

### 11. 🤿 Snorkel (스노클링 만) - 바다 탐험가
**조건**: **해산물 재료** 포함 레시피 **4개**
**구현**: `_checkSnorkelCondition()`

**해산물 키워드 (10개)**:
```dart
const seafoodKeywords = [
  '생선', '새우', '게', '조개', '굴', '전복',
  '오징어', '문어', '연어', '고등어'
];
```

**진행 방식**:
1. 레시피 재료(`ingredients`)에서 해산물 키워드 매칭
2. 해산물 재료 포함 레시피 4개 = 언락

---

### 12. 🏖️ Summer Beach (여름 해변) - 휴양지 요리사
**조건**: **휴식 키워드** 포함 레시피 **4개**
**구현**: `_checkSummerbeachCondition()`

**휴식 키워드 (7개)**:
```dart
const relaxKeywords = [
  '휴식', '쉬는', '여유', '편안', '느긋', '휴가', '바캉스'
];
```

---

### 13. 🧘 Bali Yoga (발리 요가) - 명상 요리사
**조건**: **건강 키워드** 포함 레시피 **3개**
**구현**: `_checkBaliYogaCondition()`

**건강 키워드 (7개)**:
```dart
const healthKeywords = [
  '건강', '웰빙', '요가', '명상', '마음', '몸', '균형'
];
```

---

### 14. 🚂 Orient Express (오리엔트 특급열차) - 여행 요리사
**조건**: **여행 키워드** 포함 레시피 **3개**
**구현**: `_checkOrientExpressCondition()`

**여행 키워드 (7개)**:
```dart
const travelKeywords = [
  '여행', '외국', '해외', '국가', '나라', '문화', '전통'
];
```

---

### 15. 🎨 Canvas (예술가의 아틀리에) - 예술가 요리사
**조건**: **예술 키워드** + **평점 4점 이상** 레시피 **5개**
**구현**: `_checkCanvasCondition()`

**예술 키워드 (7개)**:
```dart
const artKeywords = [
  '예술', '창작', '아름다운', '색깔', '모양', '디자인', '작품'
];
```

**진행 방식**:
1. 평점 ≥ 4점 필수
2. 감정 스토리에 예술 키워드 포함
3. 두 조건 만족하는 레시피 5개 = 언락

---

### 16. 🏝️ Vacance (바캉스 빌라) - 휴식 요리사
**조건**: **휴양 키워드** 포함 레시피 **4개**
**구현**: `_checkVacanceCondition()`

**휴양 키워드 (6개)**:
```dart
const vacationKeywords = [
  '휴가', '바캉스', '리조트', '호텔', '여유', '감사'
];
```

---

## 📊 언락 조건 요약표

| 특별공간 | 조건 유형 | 필요 레시피 수 | 추가 조건 |
|---------|----------|---------------|-----------|
| Ballroom | 사람 언급 | 3개 | 3명 이상 언급 |
| Hot Spring | 특정 감정 | 3개 | sad/tired/nostalgic 각 1개 |
| Orchestra | 모든 감정 | 8개 | 8가지 감정 모두 |
| Alchemy Lab | 재도전 | 3개 | 실패→성공 패턴 |
| Fine Dining | 평점 | 5개 | 평점 5점 필수 |
| Alps | 복합 조건 | 3개 | 재료 5개 + 평점 4+ |
| Camping | 키워드 | 4개 | 자연 키워드 |
| Autumn | 키워드 | 4개 | 가을 키워드 |
| Spring Picnic | 키워드 | 4개 | 외출 키워드 |
| Surfing | 키워드 | 4개 | 해변 키워드 |
| Snorkel | 재료 | 4개 | 해산물 재료 |
| Summer Beach | 키워드 | 4개 | 휴식 키워드 |
| Bali Yoga | 키워드 | 3개 | 건강 키워드 |
| Orient Express | 키워드 | 3개 | 여행 키워드 |
| Canvas | 복합 조건 | 5개 | 예술 키워드 + 평점 4+ |
| Vacance | 키워드 | 4개 | 휴양 키워드 |

---

## 🔧 구현 세부사항

### UnlockProgress 추적 시스템
각 특별공간마다 `UnlockProgress` 객체로 진행도 관리:
- `currentCount`: 현재 달성 수
- `requiredCount`: 필요한 레시피 수
- `processedRecipeIds`: 처리된 레시피 ID 목록 (중복 방지)
- `metadata`: 추가 정보 (언급된 사람들, 달성한 감정 등)

### 키워드 매칭 로직
1. 감정 스토리를 `toLowerCase()`로 정규화
2. `contains()` 메서드로 키워드 포함 여부 체크
3. 매칭된 키워드는 메타데이터에 저장

### 에러 처리 및 Fallback
- HiveService 에러 시 연금술실에 Fallback 로직 적용
- 키워드 매칭 실패 시 안전하게 false 반환
- 디버그 모드에서 상세한 로깅 제공

---

## 🚨 주의사항

### 중복 처리 방지
- `processedRecipeIds`로 동일한 레시피 중복 카운팅 방지
- `markRecipeAsProcessed()` 메서드로 안전한 추가

### 키워드 매칭 정확성
- 한국어 키워드는 정확히 일치해야 함
- 대소문자 구분하지 않음 (`toLowerCase()` 적용)
- 부분 매칭 가능 (예: '엄마' 키워드가 '우리 엄마가' 에서 매칭됨)

### 성능 최적화
- 조건에 맞지 않는 레시피는 조기 반환 (early return)
- 메타데이터는 JSON 형태로 효율적 저장
- 디버그 로깅은 개발 모드에서만 활성화

---

## 📝 개발자 노트

이 문서는 `burrow_unlock_service.dart` 파일의 실제 구현을 ultra think 방식으로 분석하여 작성되었습니다.

**코드 위치**:
- 성장 마일스톤: `_createDefaultMilestones()` 메서드 (32단계)
- 특별공간 조건: 각각 개별 `_check*Condition()` 메서드들
- 진행도 관리: `_getOrCreateProgress()`, `_updateSingleProgress()` 메서드들

**마지막 업데이트**: 2025-09-25
**기준 구현**: `/lib/services/burrow_unlock_service.dart` (1400+ 라인)